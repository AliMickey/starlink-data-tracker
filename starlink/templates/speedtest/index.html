{% extends 'builders/base.html' %}

{% block title %}Speedtests{% endblock %}
{% set dataType = "speedtests" %}

{% block scriptsHead %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dataTables.bootstrap5.min.css') }}">
  <script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/mapbox-gl.js') }}"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/mapbox-gl.css') }}"/>
  <script>
    $(document).ready(function() {
      var table = $('#dataTable').DataTable({
          "searching": true,
          "ordering": true,
          "order": [0, "dsc"],
          "paging":  false,
          "stateSave": false,
      });

      $('#tableSearch').keyup(function(){ 
        var input = $(this).val();
        // Hide all rows
        $('#dataTable tbody tr').hide();
        // Show each row that contains the input
        var len = $('table tbody td:nth-child(1):contains("' + input + '")').length;
        if (len > 0){
          $('#dataTable tbody td:contains("' + input + '")').each(function(){
              $(this).closest('tr').show();
          });
        };
      });
    });
  </script> 
{% endblock %}

{% block content %}
  <div class="col-11 text-center">
    <p class="fs-1 fw-bold">Starlink Speedtests</p>
    <p class="fs-3">{{ regionName }}</p>
    <div class="mx-auto col-md-2">
      <div class="form-floating">
        <select class="form-select" id="periodSelect" name="period" onfocus="this.currentValue = this.value;" onchange="changeStatPeriod(this.currentValue, this.value);this.currentValue = this.value;" autocomplete="off">
          <option value="day" {% if periodSelect == "day" %}selected{% endif %}>Day - {{ statDict['day']['current']['count'] }} results</option>
          <option value="week" {% if periodSelect == "week" %}selected{% endif %}>Week - {{ statDict['week']['current']['count'] }} results</option>
          <option value="month" {% if periodSelect == "month" %}selected{% endif %}>Month - {{ statDict['month']['current']['count'] }} results</option>
          <option value="year" {% if periodSelect == "year" %}selected{% endif %}>Year - {{ statDict['year']['current']['count'] }} results</option>
          <option value="all" {% if periodSelect == "all" %}selected{% endif %}>All - {{ statDict['all']['current']['count'] }} results</option>
        </select>
        <label for="periodSelect">Period</label>
      </div>
    </div>
    <br><br>
    {% for period in ['day', 'week', 'month', 'year', 'all'] %}
      <div class="row row-cols-1 row-cols-md-3 mb-3 g-4" id="statsText-{{period}}" {% if period != "day" %}hidden{% endif %}>
        <div class="col">
          <div class="card shadow">
            <div class="card-body">
              <div class="col">
                <p class="card-text fs-3 fw-bold text-nowrap">Latency</p>
                <div class="row row-cols-3">
                  <div class="col">
                    <p class="card-text fs-5 fw-bold text-nowrap">Min - Max</p>
                    <p class="card-text fs-5">{{ statDict[period]['current']['latency_min'] }} - {{ statDict[period]['current']['latency_max'] }}</p>
                  </div>
                  <div class="col">
                    <p class="card-text fs-5 fw-bold text-nowrap">Average</p>
                    <p class="card-text fs-5">{{ statDict[period]['current']['latency_avg'] }}</p>
                  </div>
                  <div class="col">
                    <p class="card-text fs-5 fw-bold text-nowrap">Std Dev</p>
                    <p class="card-text fs-5">{{ statDict[period]['current']['latency_sd'] }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card shadow">
            <div class="card-body">
              <div class="col">
                <p class="card-text fs-3 fw-bold text-nowrap">Download</p>
                <div class="row row-cols-3">
                  <div class="col">
                    <p class="card-text fs-5 fw-bold text-nowrap">Min - Max</p>
                    <p class="card-text fs-5">{{ statDict[period]['current']['download_min'] }} - {{ statDict[period]['current']['download_max'] }}</p>
                  </div>
                  <div class="col">
                    <p class="card-text fs-5 fw-bold text-nowrap">Average</p>
                    <p class="card-text fs-5">{{ statDict[period]['current']['download_avg'] }}</p>
                  </div>
                  <div class="col">
                    <p class="card-text fs-5 fw-bold text-nowrap">Std Dev</p>
                    <p class="card-text fs-5">{{ statDict[period]['current']['download_sd'] }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card shadow">
            <div class="card-body">
              <div class="col">
                <p class="card-text fs-3 fw-bold text-nowrap">Upload</p>
                <div class="row row-cols-3">
                  <div class="col">
                    <p class="card-text fs-5 fw-bold text-nowrap">Min - Max</p>
                    <p class="card-text fs-5">{{ statDict[period]['current']['upload_min'] }} - {{ statDict[period]['current']['upload_max'] }}</p>
                  </div>
                  <div class="col">
                    <p class="card-text fs-5 fw-bold text-nowrap">Average</p>
                    <p class="card-text fs-5">{{ statDict[period]['current']['upload_avg'] }}</p>
                  </div>
                  <div class="col">
                    <p class="card-text fs-5 fw-bold text-nowrap">Std Dev</p>
                    <p class="card-text fs-5">{{ statDict[period]['current']['upload_sd'] }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div> 
      </div>
    {% endfor %}   

    <div class="row">
      <div class="col">
        <div class="card shadow">
          <div class="card-body">
            <div class="col mb-3">
              {% for period in ['day', 'week', 'month', 'year', 'all'] %}
                <canvas id="statsChart-{{period}}" height="200" {% if period != "day" %}hidden{% endif %}></canvas>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>    
    </div>

    <br><br>

    <div class="row row-cols-1 row-cols-md-2">
      <div class="col">
        <p class="fs-4">Recently Submitted</p>
        <div class="table-responsive">
          <table class="table table-striped table-bordered" id="dataTable">
            <thead>
              <tr>
                <th>Measured (UTC)</th>
                <th>Country</th>
                <th>Latency (ms)</th>
                <th>Download (mbps)</th>
                <th>Upload (mbps)</th>
                <th>URL</th>
              </tr>
            </thead>
            <tbody>
              {% for id, details in listDict.items() %}
                <tr>
                  <td>
                    <span>{{ details['dateRun'] }}</span>
                  </td>
                  <td>
                    <span><a href="{{ url_for('speedtest.index', region=details['country']) }}" style="text-decoration: none;"><img src="https://cdn.jsdelivr.net/npm/country-flag-icons/1x1/{{ details['country'].upper() }}.svg" width="30"> {{ details['country'].upper() }}</a></span>
                  </td>
                  <td>
                    <span>{{ details['latency'] }}</span>
                  </td>
                  <td>
                    <span>{{ details['download'] }}</span>
                  </td>
                  <td>
                    <span>{{ details['upload'] }}</span>
                  </td>
                  <td>
                    <a href="{{ details['url'] }}" target="_blank"><img src="{{ url_for('static', filename='img/speedtest.png') }}" width="30px"></a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="col">
        <div class="col">
          <img id="map-hover" class="img-fluid" src="{{ url_for('static', filename='img/speedtest/placeholder-map.png') }}" style="height: 650px;">
        </div>
        <div id="map" style="height: 650px;" hidden></div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scriptsBody %}
  <script src="{{ url_for('static', filename='js/jquery.dataTables.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/dataTables.bootstrap5.min.js') }}"></script>
  <script>
    function changeStatPeriod(currentPeriod, selectedPeriod) {
        const currentStatDiv = document.getElementById("statsText-" + currentPeriod);
        const currentChartDiv = document.getElementById("statsChart-" + currentPeriod);
        currentStatDiv.hidden = true
        currentChartDiv.hidden = true
        const selectedStatDiv = document.getElementById("statsText-" + selectedPeriod);
        const selectedChartDiv = document.getElementById("statsChart-" + selectedPeriod);
        selectedStatDiv.hidden = false
        selectedChartDiv.hidden = false
    }
  </script>  

  <script>
    const ctxChartDay = document.getElementById('statsChart-day');
    const ctxChartWeek = document.getElementById('statsChart-week');
    const ctxChartMonth = document.getElementById('statsChart-month');
    const ctxChartYear = document.getElementById('statsChart-year');
    const ctxChartAll = document.getElementById('statsChart-all');

    const statsChartDay = new Chart(ctxChartDay, {
      type: 'bar',
      data: {
        labels: ['12AM', '1AM', '2AM', '3AM', '4AM', '5AM', '6AM', '7AM', '8AM', '9AM', '10AM', '11AM', '12PM', '1PM', '2PM', '3PM', '4PM', '5PM', '6PM', '7PM', '8PM', '9PM', '10PM', '11PM'],
        datasets: [
          {
            label: 'Latency',
            hidden: true,
            borderRadius: 3,
            backgroundColor: ['rgba(228, 26, 28, 0.7)'],
            borderColor: ['rgba(228, 26, 28, 1)'],
            data: ["{{ statDict['day']['aggregate']['00']['latency_avg'] }}", "{{ statDict['day']['aggregate']['01']['latency_avg'] }}",
              "{{ statDict['day']['aggregate']['02']['latency_avg'] }}", "{{ statDict['day']['aggregate']['03']['latency_avg'] }}", 
              "{{ statDict['day']['aggregate']['04']['latency_avg'] }}", "{{ statDict['day']['aggregate']['05']['latency_avg'] }}", 
              "{{ statDict['day']['aggregate']['06']['latency_avg'] }}", "{{ statDict['day']['aggregate']['07']['latency_avg'] }}", 
              "{{ statDict['day']['aggregate']['08']['latency_avg'] }}", "{{ statDict['day']['aggregate']['09']['latency_avg'] }}", 
              "{{ statDict['day']['aggregate']['10']['latency_avg'] }}", "{{ statDict['day']['aggregate']['11']['latency_avg'] }}", 
              "{{ statDict['day']['aggregate']['12']['latency_avg'] }}", "{{ statDict['day']['aggregate']['13']['latency_avg'] }}", 
              "{{ statDict['day']['aggregate']['14']['latency_avg'] }}", "{{ statDict['day']['aggregate']['15']['latency_avg'] }}", 
              "{{ statDict['day']['aggregate']['16']['latency_avg'] }}", "{{ statDict['day']['aggregate']['17']['latency_avg'] }}", 
              "{{ statDict['day']['aggregate']['18']['latency_avg'] }}", "{{ statDict['day']['aggregate']['19']['latency_avg'] }}", 
              "{{ statDict['day']['aggregate']['20']['latency_avg'] }}", "{{ statDict['day']['aggregate']['21']['latency_avg'] }}", 
              "{{ statDict['day']['aggregate']['22']['latency_avg'] }}", "{{ statDict['day']['aggregate']['23']['latency_avg'] }}"]
          },
          {
            label: 'Download',
            hidden: false,
            borderRadius: 3,
            backgroundColor: ['rgba(55, 126, 184, 0.7)'],
            borderColor: ['rgba(55, 126, 184, 1)'],
            data: ["{{ statDict['day']['aggregate']['00']['download_avg'] }}", "{{ statDict['day']['aggregate']['01']['download_avg'] }}",
            "{{ statDict['day']['aggregate']['02']['download_avg'] }}", "{{ statDict['day']['aggregate']['03']['download_avg'] }}",
            "{{ statDict['day']['aggregate']['04']['download_avg'] }}", "{{ statDict['day']['aggregate']['05']['download_avg'] }}",
            "{{ statDict['day']['aggregate']['06']['download_avg'] }}", "{{ statDict['day']['aggregate']['07']['download_avg'] }}",
            "{{ statDict['day']['aggregate']['08']['download_avg'] }}", "{{ statDict['day']['aggregate']['09']['download_avg'] }}",
            "{{ statDict['day']['aggregate']['10']['download_avg'] }}", "{{ statDict['day']['aggregate']['11']['download_avg'] }}",
            "{{ statDict['day']['aggregate']['12']['download_avg'] }}", "{{ statDict['day']['aggregate']['13']['download_avg'] }}",
            "{{ statDict['day']['aggregate']['14']['download_avg'] }}", "{{ statDict['day']['aggregate']['15']['download_avg'] }}",
            "{{ statDict['day']['aggregate']['16']['download_avg'] }}", "{{ statDict['day']['aggregate']['17']['download_avg'] }}",
            "{{ statDict['day']['aggregate']['18']['download_avg'] }}", "{{ statDict['day']['aggregate']['19']['download_avg'] }}",
            "{{ statDict['day']['aggregate']['20']['download_avg'] }}", "{{ statDict['day']['aggregate']['21']['download_avg'] }}",
            "{{ statDict['day']['aggregate']['22']['download_avg'] }}", "{{ statDict['day']['aggregate']['23']['download_avg'] }}"]
          },
          {
            label: 'Upload',
            hidden: true,
            borderRadius: 3,
            backgroundColor: ['rgba(77, 175, 74, 0.7)'],
            borderColor: ['rgba(77, 175, 74, 1)'],
            data: ["{{ statDict['day']['aggregate']['00']['upload_avg'] }}", "{{ statDict['day']['aggregate']['01']['upload_avg'] }}",
            "{{ statDict['day']['aggregate']['02']['upload_avg'] }}", "{{ statDict['day']['aggregate']['03']['upload_avg'] }}",
            "{{ statDict['day']['aggregate']['06']['upload_avg'] }}", "{{ statDict['day']['aggregate']['05']['upload_avg'] }}",
            "{{ statDict['day']['aggregate']['06']['upload_avg'] }}", "{{ statDict['day']['aggregate']['07']['upload_avg'] }}",
            "{{ statDict['day']['aggregate']['08']['upload_avg'] }}", "{{ statDict['day']['aggregate']['09']['upload_avg'] }}",
            "{{ statDict['day']['aggregate']['10']['upload_avg'] }}", "{{ statDict['day']['aggregate']['11']['upload_avg'] }}",
            "{{ statDict['day']['aggregate']['12']['upload_avg'] }}", "{{ statDict['day']['aggregate']['13']['upload_avg'] }}",
            "{{ statDict['day']['aggregate']['14']['upload_avg'] }}", "{{ statDict['day']['aggregate']['15']['upload_avg'] }}",
            "{{ statDict['day']['aggregate']['16']['upload_avg'] }}", "{{ statDict['day']['aggregate']['17']['upload_avg'] }}",
            "{{ statDict['day']['aggregate']['18']['upload_avg'] }}", "{{ statDict['day']['aggregate']['19']['upload_avg'] }}",
            "{{ statDict['day']['aggregate']['20']['upload_avg'] }}", "{{ statDict['day']['aggregate']['21']['upload_avg'] }}",
            "{{ statDict['day']['aggregate']['22']['upload_avg'] }}", "{{ statDict['day']['aggregate']['23']['upload_avg'] }}"]
          }      
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
      }
    });

    const statsChartWeek = new Chart(ctxChartWeek, {
      type: 'bar',
      data: {
        labels: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
        datasets: [
          {
            label: 'Latency',
            hidden: true,
            borderRadius: 3,
            backgroundColor: ['rgba(228, 26, 28, 0.7)'],
            borderColor: ['rgba(228, 26, 28, 1)'],
            data: ["{{ statDict['week']['aggregate']['0']['latency_avg'] }}", "{{ statDict['week']['aggregate']['1']['latency_avg'] }}",
              "{{ statDict['week']['aggregate']['2']['latency_avg'] }}", "{{ statDict['week']['aggregate']['3']['latency_avg'] }}",
              "{{ statDict['week']['aggregate']['4']['latency_avg'] }}", "{{ statDict['week']['aggregate']['5']['latency_avg'] }}",
              "{{ statDict['week']['aggregate']['6']['latency_avg'] }}"]
          },
          {
            label: 'Download',
            hidden: false,
            borderRadius: 3,
            backgroundColor: ['rgba(55, 126, 184, 0.7)'],
            borderColor: ['rgba(55, 126, 184, 1)'],
            data: ["{{ statDict['week']['aggregate']['0']['download_avg'] }}", "{{ statDict['week']['aggregate']['1']['download_avg'] }}",
              "{{ statDict['week']['aggregate']['2']['download_avg'] }}", "{{ statDict['week']['aggregate']['3']['download_avg'] }}",
              "{{ statDict['week']['aggregate']['4']['download_avg'] }}", "{{ statDict['week']['aggregate']['5']['download_avg'] }}",
              "{{ statDict['week']['aggregate']['6']['download_avg'] }}"]
          },
          {
            label: 'Upload',
            hidden: true,
            borderRadius: 3,
            backgroundColor: ['rgba(77, 175, 74, 0.7)'],
            borderColor: ['rgba(77, 175, 74, 1)'],
            data: ["{{ statDict['week']['aggregate']['0']['upload_avg'] }}", "{{ statDict['week']['aggregate']['1']['upload_avg'] }}",
              "{{ statDict['week']['aggregate']['2']['upload_avg'] }}", "{{ statDict['week']['aggregate']['3']['upload_avg'] }}",
              "{{ statDict['week']['aggregate']['4']['upload_avg'] }}", "{{ statDict['week']['aggregate']['5']['upload_avg'] }}",
              "{{ statDict['week']['aggregate']['6']['upload_avg'] }}"]
          }      
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
      }
    });

    const statsChartMonth = new Chart(ctxChartMonth, {
      type: 'bar',
      data: {
        labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31'],
        datasets: [
          {
            label: 'Latency',
            hidden: true,
            borderRadius: 3,
            backgroundColor: ['rgba(228, 26, 28, 0.7)'],
            borderColor: ['rgba(228, 26, 28, 1)'],
            data: ["{{ statDict['month']['aggregate']['01']['latency_avg'] }}", "{{ statDict['month']['aggregate']['02']['latency_avg'] }}",
              "{{ statDict['month']['aggregate']['03']['latency_avg'] }}", "{{ statDict['month']['aggregate']['04']['latency_avg'] }}",
              "{{ statDict['month']['aggregate']['05']['latency_avg'] }}", "{{ statDict['month']['aggregate']['06']['latency_avg'] }}",
              "{{ statDict['month']['aggregate']['07']['latency_avg'] }}", "{{ statDict['month']['aggregate']['08']['latency_avg'] }}",
              "{{ statDict['month']['aggregate']['09']['latency_avg'] }}", "{{ statDict['month']['aggregate']['10']['latency_avg'] }}",
              "{{ statDict['month']['aggregate']['11']['latency_avg'] }}", "{{ statDict['month']['aggregate']['12']['latency_avg'] }}",
              "{{ statDict['month']['aggregate']['13']['latency_avg'] }}", "{{ statDict['month']['aggregate']['14']['latency_avg'] }}",
              "{{ statDict['month']['aggregate']['15']['latency_avg'] }}", "{{ statDict['month']['aggregate']['16']['latency_avg'] }}",
              "{{ statDict['month']['aggregate']['17']['latency_avg'] }}", "{{ statDict['month']['aggregate']['18']['latency_avg'] }}",
              "{{ statDict['month']['aggregate']['19']['latency_avg'] }}", "{{ statDict['month']['aggregate']['20']['latency_avg'] }}",
              "{{ statDict['month']['aggregate']['21']['latency_avg'] }}", "{{ statDict['month']['aggregate']['22']['latency_avg'] }}",
              "{{ statDict['month']['aggregate']['23']['latency_avg'] }}", "{{ statDict['month']['aggregate']['24']['latency_avg'] }}",
              "{{ statDict['month']['aggregate']['25']['latency_avg'] }}", "{{ statDict['month']['aggregate']['26']['latency_avg'] }}",
              "{{ statDict['month']['aggregate']['27']['latency_avg'] }}", "{{ statDict['month']['aggregate']['28']['latency_avg'] }}",
              "{{ statDict['month']['aggregate']['29']['latency_avg'] }}", "{{ statDict['month']['aggregate']['30']['latency_avg'] }}",
              "{{ statDict['month']['aggregate']['31']['latency_avg'] }}"]
          },
          {
            label: 'Download',
            hidden: false,
            borderRadius: 3,
            backgroundColor: ['rgba(55, 126, 184, 0.7)'],
            borderColor: ['rgba(55, 126, 184, 1)'],
            data: ["{{ statDict['month']['aggregate']['01']['download_avg'] }}", "{{ statDict['month']['aggregate']['02']['download_avg'] }}",
              "{{ statDict['month']['aggregate']['03']['download_avg'] }}", "{{ statDict['month']['aggregate']['04']['download_avg'] }}",
              "{{ statDict['month']['aggregate']['05']['download_avg'] }}", "{{ statDict['month']['aggregate']['06']['download_avg'] }}",
              "{{ statDict['month']['aggregate']['07']['download_avg'] }}", "{{ statDict['month']['aggregate']['08']['download_avg'] }}",
              "{{ statDict['month']['aggregate']['09']['download_avg'] }}", "{{ statDict['month']['aggregate']['10']['download_avg'] }}",
              "{{ statDict['month']['aggregate']['11']['download_avg'] }}", "{{ statDict['month']['aggregate']['12']['download_avg'] }}",
              "{{ statDict['month']['aggregate']['13']['download_avg'] }}", "{{ statDict['month']['aggregate']['14']['download_avg'] }}",
              "{{ statDict['month']['aggregate']['15']['download_avg'] }}", "{{ statDict['month']['aggregate']['16']['download_avg'] }}",
              "{{ statDict['month']['aggregate']['17']['download_avg'] }}", "{{ statDict['month']['aggregate']['18']['download_avg'] }}",
              "{{ statDict['month']['aggregate']['19']['download_avg'] }}", "{{ statDict['month']['aggregate']['20']['download_avg'] }}",
              "{{ statDict['month']['aggregate']['21']['download_avg'] }}", "{{ statDict['month']['aggregate']['22']['download_avg'] }}",
              "{{ statDict['month']['aggregate']['23']['download_avg'] }}", "{{ statDict['month']['aggregate']['24']['download_avg'] }}",
              "{{ statDict['month']['aggregate']['25']['download_avg'] }}", "{{ statDict['month']['aggregate']['26']['download_avg'] }}",
              "{{ statDict['month']['aggregate']['27']['download_avg'] }}", "{{ statDict['month']['aggregate']['28']['download_avg'] }}",
              "{{ statDict['month']['aggregate']['29']['download_avg'] }}", "{{ statDict['month']['aggregate']['30']['download_avg'] }}",
              "{{ statDict['month']['aggregate']['31']['download_avg'] }}"]
          },
          {
            label: 'Upload',
            hidden: true,
            borderRadius: 3,
            backgroundColor: ['rgba(77, 175, 74, 0.7)'],
            borderColor: ['rgba(77, 175, 74, 1)'],
            data: ["{{ statDict['month']['aggregate']['01']['upload_avg'] }}", "{{ statDict['month']['aggregate']['02']['upload_avg'] }}",
              "{{ statDict['month']['aggregate']['03']['upload_avg'] }}", "{{ statDict['month']['aggregate']['04']['upload_avg'] }}",
              "{{ statDict['month']['aggregate']['05']['upload_avg'] }}", "{{ statDict['month']['aggregate']['06']['upload_avg'] }}",
              "{{ statDict['month']['aggregate']['07']['upload_avg'] }}", "{{ statDict['month']['aggregate']['08']['upload_avg'] }}",
              "{{ statDict['month']['aggregate']['09']['upload_avg'] }}", "{{ statDict['month']['aggregate']['10']['upload_avg'] }}",
              "{{ statDict['month']['aggregate']['11']['upload_avg'] }}", "{{ statDict['month']['aggregate']['12']['upload_avg'] }}",
              "{{ statDict['month']['aggregate']['13']['upload_avg'] }}", "{{ statDict['month']['aggregate']['14']['upload_avg'] }}",
              "{{ statDict['month']['aggregate']['15']['upload_avg'] }}", "{{ statDict['month']['aggregate']['16']['upload_avg'] }}",
              "{{ statDict['month']['aggregate']['17']['upload_avg'] }}", "{{ statDict['month']['aggregate']['18']['upload_avg'] }}",
              "{{ statDict['month']['aggregate']['19']['upload_avg'] }}", "{{ statDict['month']['aggregate']['20']['upload_avg'] }}",
              "{{ statDict['month']['aggregate']['21']['upload_avg'] }}", "{{ statDict['month']['aggregate']['22']['upload_avg'] }}",
              "{{ statDict['month']['aggregate']['23']['upload_avg'] }}", "{{ statDict['month']['aggregate']['24']['upload_avg'] }}",
              "{{ statDict['month']['aggregate']['25']['upload_avg'] }}", "{{ statDict['month']['aggregate']['26']['upload_avg'] }}",
              "{{ statDict['month']['aggregate']['27']['upload_avg'] }}", "{{ statDict['month']['aggregate']['28']['upload_avg'] }}",
              "{{ statDict['month']['aggregate']['29']['upload_avg'] }}", "{{ statDict['month']['aggregate']['30']['upload_avg'] }}",
              "{{ statDict['month']['aggregate']['31']['upload_avg'] }}"]
          }      
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
      }
    });

    const statsChartYear = new Chart(ctxChartYear, {
      type: 'bar',
      data: {
        labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
        datasets: [
          {
            label: 'Latency',
            hidden: true,
            borderRadius: 3,
            backgroundColor: ['rgba(228, 26, 28, 0.7)'],
            borderColor: ['rgba(228, 26, 28, 1)'],
            data: ["{{ statDict['year']['aggregate']['01']['latency_avg'] }}", "{{ statDict['year']['aggregate']['02']['latency_avg'] }}",
              "{{ statDict['year']['aggregate']['03']['latency_avg'] }}", "{{ statDict['year']['aggregate']['04']['latency_avg'] }}",
              "{{ statDict['year']['aggregate']['05']['latency_avg'] }}", "{{ statDict['year']['aggregate']['06']['latency_avg'] }}",
              "{{ statDict['year']['aggregate']['07']['latency_avg'] }}", "{{ statDict['year']['aggregate']['08']['latency_avg'] }}",
              "{{ statDict['year']['aggregate']['09']['latency_avg'] }}", "{{ statDict['year']['aggregate']['10']['latency_avg'] }}",
              "{{ statDict['year']['aggregate']['11']['latency_avg'] }}","{{ statDict['year']['aggregate']['12']['latency_avg'] }}"]
            },
            {
              label: 'Download',
              hidden: false,
              borderRadius: 3,
              backgroundColor: ['rgba(55, 126, 184, 0.7)'],
              borderColor: ['rgba(55, 126, 184, 1)'],
              data: ["{{ statDict['year']['aggregate']['01']['download_avg'] }}", "{{ statDict['year']['aggregate']['02']['download_avg'] }}",
              "{{ statDict['year']['aggregate']['03']['download_avg'] }}", "{{ statDict['year']['aggregate']['04']['download_avg'] }}",
              "{{ statDict['year']['aggregate']['05']['download_avg'] }}", "{{ statDict['year']['aggregate']['06']['download_avg'] }}",
              "{{ statDict['year']['aggregate']['07']['download_avg'] }}", "{{ statDict['year']['aggregate']['08']['download_avg'] }}",
              "{{ statDict['year']['aggregate']['09']['download_avg'] }}", "{{ statDict['year']['aggregate']['10']['download_avg'] }}",
              "{{ statDict['year']['aggregate']['11']['download_avg'] }}","{{ statDict['year']['aggregate']['12']['download_avg'] }}"]
            },
            {
              label: 'Upload',
              hidden: true,
              borderRadius: 3,
              backgroundColor: ['rgba(77, 175, 74, 0.7)'],
              borderColor: ['rgba(77, 175, 74, 1)'],
              data: ["{{ statDict['year']['aggregate']['01']['upload_avg'] }}", "{{ statDict['year']['aggregate']['02']['upload_avg'] }}",
              "{{ statDict['year']['aggregate']['03']['upload_avg'] }}", "{{ statDict['year']['aggregate']['04']['upload_avg'] }}",
              "{{ statDict['year']['aggregate']['05']['upload_avg'] }}", "{{ statDict['year']['aggregate']['06']['upload_avg'] }}",
              "{{ statDict['year']['aggregate']['07']['upload_avg'] }}", "{{ statDict['year']['aggregate']['08']['upload_avg'] }}",
              "{{ statDict['year']['aggregate']['09']['upload_avg'] }}", "{{ statDict['year']['aggregate']['10']['upload_avg'] }}",
              "{{ statDict['year']['aggregate']['11']['upload_avg'] }}","{{ statDict['year']['aggregate']['12']['upload_avg'] }}"]
          }      
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
      }
    });

    const statsChartAll = new Chart(ctxChartAll, {
      type: 'bar',
      data: {
        labels: ['2021', '2022'],
        datasets: [
          {
            label: 'Latency',
            hidden: true,
            borderRadius: 3,
            backgroundColor: ['rgba(228, 26, 28, 0.7)'],
            borderColor: ['rgba(228, 26, 28, 1)'],
            data: ["{{ statDict['all']['aggregate']['2021']['latency_avg'] }}", "{{ statDict['all']['aggregate']['2022']['latency_avg'] }}"]
            },
            {
              label: 'Download',
              hidden: false,
              borderRadius: 3,
              backgroundColor: ['rgba(55, 126, 184, 0.7)'],
              borderColor: ['rgba(55, 126, 184, 1)'],
              data: ["{{ statDict['all']['aggregate']['2021']['download_avg'] }}", "{{ statDict['all']['aggregate']['2022']['download_avg'] }}"]
            },
            {
              label: 'Upload',
              hidden: true,
              borderRadius: 3,
              backgroundColor: ['rgba(77, 175, 74, 0.7)'],
              borderColor: ['rgba(77, 175, 74, 1)'],
              data: ["{{ statDict['all']['aggregate']['2021']['upload_avg'] }}", "{{ statDict['all']['aggregate']['2022']['upload_avg'] }}"]
          }      
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
      }
    });
  </script>

  <script>
    $('#map-hover').click(
      function() {
        const mapHoverDiv = document.getElementById("map-hover");
        mapHoverDiv.hidden = true
        const mapDiv = document.getElementById("map");
        mapDiv.hidden = false
        mapboxgl.accessToken = "{{ mapboxKey }}";
        let hoveredStateId = null;
        const zoomThreshold = 2;
        var map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/light-v10',
          minZoom: 0.9,
          zoom: 0.9,
          center: [21.514, 40.112]
        });
        map.addControl(new mapboxgl.NavigationControl());
        map.addControl(new mapboxgl.FullscreenControl());
        
        // Layer sources
        map.on('load', function() {
          map.addSource('countries', {
            'type': 'vector',
            'url': "mapbox://mapbox.country-boundaries-v1",
            });

          map.addSource('continents', {
            'type': 'geojson',
            'data': "{{ url_for('static', filename='other/continents.geojson') }}",
            'generateId': true
          });

          // Layer colour fills
          map.addLayer({
            'id': 'countries-fills',
            'type': 'fill',
            'source': 'countries',
            'source-layer': 'country_boundaries',
            'minzoom': zoomThreshold,
            'layout': {},
            'paint': {
              'fill-color': '#627BC1',
              'fill-opacity': [
                'case',
                  ['boolean', ['feature-state', 'hover'], false],
                  0.1,
                  0.5   
              ]
            },
            filter: [
              'all',
              ['match', ['get', 'worldview'], ['all', 'US'], true, false],
              ["!=", "true", ["get", "disputed"]],
            ]
            });

          map.addLayer({
            'id': 'continents-fills',
            'type': 'fill',
            'source': 'continents',
            'maxzoom': zoomThreshold,
            'layout': {},
            'paint': {
              'fill-color': '#C2A863',
              'fill-opacity': [
                'case',
                  ['boolean', ['feature-state', 'hover'], false],
                  0.1,
                  0.7
              ]
            }
          });
          
          // Layer borders
          map.addLayer({
            'id': 'countries-borders',
            'type': 'line',
            'source': 'countries',
            'source-layer': 'country_boundaries',
            'layout': {},
            'paint': {
              'line-color': '#627BC1',
              'line-width': 2
            }
          });

          map.addLayer({
            'id': 'continents-borders',
            'type': 'line',
            'source': 'continents',
            'layout': {},
            'paint': {
              'line-color': '#627BC1',
              'line-width': 3
            }
          });
          map.fitBounds([
            ["{{ regionBbox['sw']['lon'] }}", "{{ regionBbox['sw']['lat'] }}"],
            ["{{ regionBbox['ne']['lon'] }}", "{{ regionBbox['ne']['lat'] }}"]
          ]);

          // Get cursor coordinates for development
          // map.on('mousemove', (e) => {
          //   console.log(e.lngLat)
          // });

          // On move listener for layers
          map.on('mousemove', 'countries-fills', (e) => {
            if (e.features.length > 0) {
              if (hoveredStateId !== null) {
                map.setFeatureState(
                  { source: 'countries', sourceLayer: 'country_boundaries', id: hoveredStateId },
                  { hover: false }
                );
              }
              hoveredStateId = e.features[0].id;
              map.setFeatureState(
                { source: 'countries', sourceLayer: 'country_boundaries', id: hoveredStateId },
                { hover: true }
              )
            }
          });

          map.on('mousemove', 'continents-fills', (e) => {
            if (e.features.length > 0) {
              if (hoveredStateId !== null) {
                map.setFeatureState(
                  { source: 'continents', id: hoveredStateId },
                  { hover: false }
                )
              }
              hoveredStateId = e.features[0].id;
              map.setFeatureState(
                { source: 'continents', id: hoveredStateId },
                { hover: true }
              );
            }
          });
          
          // On mouse leave listener for layers
          map.on('mouseleave', 'countries-fills', () => {
            if (hoveredStateId !== null) {
              map.setFeatureState(
                { source: 'countries', sourceLayer: 'country_boundaries', id: hoveredStateId},
                { hover: false }
              );
            }
            hoveredStateId = null;
          });

          map.on('mouseleave', 'continents-fills', () => {
            if (hoveredStateId !== null) {
              map.setFeatureState(
                { source: 'continents', id: hoveredStateId},
                { hover: false }
              );
            }
            hoveredStateId = null;
          });
          
          // Click listener for layers
          map.on("click", 'countries-fills', function(e) {
            var features = map.queryRenderedFeatures(e.point, { layers: ["countries-fills"] });
            if (features.length) {
              // Url must be built seperately as jinja set at render time
              url = "{{ url_for('speedtest.index') }}/region/" + features[0].properties.iso_3166_1.toLowerCase()
              location.href = url
            }
          });

          map.on("click", 'continents-fills', function(e) {
            var features = map.queryRenderedFeatures(e.point, { layers: ["continents-fills"] });
            if (features.length) {
              // Url must be built seperately as jinja set at render time
              url = "{{ url_for('speedtest.index') }}/region/" + features[0].properties.name.toLowerCase()
              location.href = url
            }
          });
        });
      }
    );
  </script>
{% endblock %}